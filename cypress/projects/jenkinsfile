pipeline {
     options {
            disableConcurrentBuilds()
        }
    agent {
        label "agent"
    }

    triggers {
        pollSCM ('H H(9-16)/2 * * 1-5)')
    }

    stages {
        stage('Install') {
            steps {
                script {
                    sh 'rm -R -f /var/jenkins_home/workspace/gwm-stage-UI/mochawesome-report'
                    sh 'rm -R -f /var/jenkins_home/workspace/gwm-stage-UI/cypress'
                    sh 'yarn install'
                }
            }
        }


        stage('test') {
            steps {
                script {
                    try {
                        sh 'yarn run:gwm:stage'
                    } catch (e) {
                        sh 'curl -H "Content-Type: application/json" -d \'{"msgtype": "text","text":{"content":"MK UAT UI 自动化测试失败"}}\'https://oapi.dingtalk.com/robot/send?access_token=edc0e25619ece3f30bfbbd6ea56e3bffef7e3ff18430a04048f00846947ad00f'
                        error 'MK UI 自动化测试失败'
                    } finally {
                        sh 'yarn report'
                    }
                }
            }
        }
    }


    post {
        failure {
            archiveArtifacts artifacts: 'cypress/screenshots/**/*.png'
        }
        always {
            publishHTML([
                    allowMissing         : false,
                    alwaysLinkToLastBuild: false,
                    keepAll              : false,
                    reportDir            : './mochawesome-report',
                    reportFiles          : '*.html',
                    reportName           : 'reports',
                    reportTitles         : 'HTML Report'
            ]
            )
        }
    }
}
