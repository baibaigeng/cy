pipeline {
     options {
            disableConcurrentBuilds()
        }
    agent {
        label "agent"
    }

    triggers {
        pollSCM ('H 7,8,9,11,12,13,14,15,16,17,18,19,20,21 * * *')
    }

    stages {
        stage('Install') {
            steps {
                script {
                    sh 'rm -R -f /var/jenkins_home/workspace/cypress/mochawesome-report'
                    sh 'rm -R -f /var/jenkins_home/workspace/nba-uat-ui/cypress'
                    sh 'cnpm install /root/.cache/Cypress/12.2.0/Cypress/Cypress'
                    sh 'chmod 777 /root/.jenkins/workspace/GWM-stage-UI/node_modules/.bin/cypress'
                }
            }
        }


        stage('test') {
            steps {
                script {
                    try {
                        sh 'yarn run run:gwm:stage'
                    } catch (e) {
                        sh 'curl -H "Content-Type: application/json" -d \'{"msgtype": "text","text":{"content":"MK UAT UI 自动化测试失败"}}\'https://oapi.dingtalk.com/robot/send?access_token=edc0e25619ece3f30bfbbd6ea56e3bffef7e3ff18430a04048f00846947ad00f'
                        error 'MK UI 自动化测试失败'
                    } finally {
                        sh 'yarn report'
                    }
                }
            }
        }
    }


    post {
        failure {
            archiveArtifacts artifacts: 'cypress/screenshots/**/*.png'
        }
        always {
            publishHTML([
                    allowMissing         : false,
                    alwaysLinkToLastBuild: false,
                    keepAll              : false,
                    reportDir            : './mochawesome-report',
                    reportFiles          : '*.html',
                    reportName           : 'reports',
                    reportTitles         : 'HTML Report'
            ]
            )
        }
    }
}
