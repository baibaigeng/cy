pipeline {
     options {
            disableConcurrentBuilds()
        }
    agent {
        label "agent"
    }

    triggers {
        pollSCM ('H 7,8,9,11,12,13,14,15,16,17,18,19,20,21 * * *')
    }

    stages {
        stage('Install') {
            steps {
                script {
                    sh 'rm -R -f /var/jenkins_home/workspace/cypress/mochawesome-report'
                    sh 'rm -R -f /var/jenkins_home/workspace/nba-uat-ui/cypress'
                    sh 'yarn install'
                    sh 'yarn add cypress --dev'
                    sh 'chmod 777 /root/.jenkins/workspace/GWM-stage-UI/node_modules/.bin/cypress'
                }
            }
        }


        stage('test') {
            steps {
                script {
                    try {
                        sh 'yarn run:gwm:prod'
                    } catch (e) {
                        curl 'https://oapi.dingtalk.com/robot/send?access_token=297a00fe174b436d81462b1d26de678a16e9caf190fbfd6b85709d4d40d129b9'
                        error 'nba UI 自动化测试失败'
                        error 'MK UI 自动化测试失败'
                    } finally {
                        sh 'npm run report'
                    }
                }
            }
        }
    }


    post {
        failure {
            archiveArtifacts artifacts: 'cypress/screenshots/**/*.png'
        }
        always {
            publishHTML([
                    allowMissing         : false,
                    alwaysLinkToLastBuild: false,
                    keepAll              : false,
                    reportDir            : './mochawesome-report',
                    reportFiles          : '*.html',
                    reportName           : 'reports',
                    reportTitles         : 'HTML Report'
            ]
            )
        }
    }
}
